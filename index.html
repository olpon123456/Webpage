<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Decoded ad URL</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Arial,-apple-system,Segoe UI;display:flex;align-items:center;justify-content:center;background:#111;color:#fff}
    .center{max-width:900px;padding:24px;text-align:center}
    .url{word-break:break-all;font-size:20px;background:#0b0b0b;padding:18px;border-radius:8px;border:1px solid #222}
    .msg{opacity:.85;margin-top:12px;font-size:14px;color:#ddd}
    iframe#decoderFrame{display:none !important;width:1px;height:1px;border:0;position:absolute;left:-9999px;top:-9999px}
  </style>
</head>
<body>
  <div id="root" class="center">
    <div id="loading" class="msg">Decoding ad loader — waiting for decoded ad URL...</div>
  </div>

  <!-- hidden sandboxed iframe where loader runs and atob() is intercepted -->
  <iframe id="decoderFrame" sandbox="allow-scripts"></iframe>

  <script>
  (function(){
    const LOADER_URL = 'https://webpage-76ur.onrender.com/get-adcode'; // change if needed
    const TIMEOUT_MS = 10000; // how long to wait for decode before showing error
    const root = document.getElementById('root');
    const loadingEl = document.getElementById('loading');
    const iframe = document.getElementById('decoderFrame');

    function showOnlyMessage(title, message, sub){
      document.title = title || document.title;
      root.innerHTML = '';
      const box = document.createElement('div');
      box.style.display = 'flex';
      box.style.flexDirection = 'column';
      box.style.alignItems = 'center';
      box.style.justifyContent = 'center';
      const urlEl = document.createElement('div');
      urlEl.className = 'url';
      urlEl.textContent = message;
      box.appendChild(urlEl);
      if(sub){
        const subEl = document.createElement('div');
        subEl.className = 'msg';
        subEl.textContent = sub;
        box.appendChild(subEl);
      }
      root.appendChild(box);
    }

    // Build the iframe HTML as a plain string and return a Blob URL.
    // The loaderSourceText is inserted verbatim into the iframe HTML (safe because we use a Blob).
    function makeIframeBlobUrl(loaderSourceText){
      const iframeHtml = `
<!doctype html>
<html>
  <head><meta charset="utf-8"><title>decoder-frame</title></head>
  <body>
    <script>
      (function(){
        // intercept atob and forward decoded values to parent
        const nativeAtob = window.atob;
        window.atob = function(s){
          const decoded = nativeAtob.call(this, s);
          try{ parent.postMessage({type:'atob-decoded', decoded: decoded}, '*'); }catch(e){}
          return decoded;
        };
        // forward console.log to parent (optional)
        (function(){
          const nativeLog = console.log.bind(console);
          console.log = function(){
            try{ parent.postMessage({type:'console', args: Array.from(arguments)}, '*'); }catch(e){}
            nativeLog.apply(console, arguments);
          };
        })();

        // run the loader code:
        try{
          ${loaderSourceText}
        }catch(e){
          try{ parent.postMessage({type:'loader-error', message: String(e)}, '*'); }catch(err){}
        }
      })();
    </script>
  </body>
</html>
`;
      const blob = new Blob([iframeHtml], { type: 'text/html' });
      return URL.createObjectURL(blob);
    }

    async function start(){
      loadingEl.textContent = 'Fetching loader...';
      let codeText = null;
      try{
        const res = await fetch(LOADER_URL, {mode:'cors'});
        if(!res.ok) throw new Error('fetch failed: ' + res.status);
        codeText = await res.text();
      }catch(err){
        showOnlyMessage('Decode error', 'Failed to fetch loader', String(err));
        return;
      }

      // Create a blob URL for the iframe that includes the loader code.
      // Using a blob avoids the need to escape </script> sequences.
      let blobUrl;
      try{
        blobUrl = makeIframeBlobUrl(codeText);
      }catch(e){
        showOnlyMessage('Internal error', 'Failed to prepare iframe', String(e));
        return;
      }

      // Point the hidden iframe to the blob URL
      iframe.src = blobUrl;
      loadingEl.textContent = 'Loader loaded in sandbox — waiting for atob decode...';

      // Prepare timeout
      const t = setTimeout(()=>{
        window.removeEventListener('message', onMessage);
        showOnlyMessage('No decoded URL', 'No URL decoded within timeout (' + (TIMEOUT_MS/1000) + 's).', 'Check loader, CORS or network.');
        try{ URL.revokeObjectURL(blobUrl); }catch(e){}
      }, TIMEOUT_MS);

      // Message handler
      function onMessage(ev){
        try{
          const d = ev.data || {};
          if(d && d.type === 'atob-decoded'){
            const decoded = String(d.decoded || '').trim();
            if(!decoded) return;
            if(/^https?:\/\/./i.test(decoded)){
              clearTimeout(t);
              window.removeEventListener('message', onMessage);
              try{ URL.revokeObjectURL(blobUrl); }catch(e){}
              showOnlyMessage('Decoded ad URL', decoded, 'Decoded from loader atob()');
            } else {
              // Show non-URL decoded content but keep waiting for an https URL until timeout
              showOnlyMessage('Decoded (non-URL)', decoded, 'Waiting for an https:// decode until timeout');
            }
          } else if(d && d.type === 'loader-error'){
            clearTimeout(t);
            window.removeEventListener('message', onMessage);
            try{ URL.revokeObjectURL(blobUrl); }catch(e){}
            showOnlyMessage('Loader error', d.message || 'Unknown loader error');
          }
        }catch(e){
          // ignore
        }
      }

      window.addEventListener('message', onMessage);
    }

    // start immediately
    start();
  })();
  </script>
</body>
</html>