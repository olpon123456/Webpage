import express from "express";

// âœ… You can remove node-fetch (Render uses Node 18+ which includes fetch)
const app = express();
const PORT = process.env.PORT || 3000;

// âœ… Use your real API key and website ID (set these in Render environment)
const POPADS_API_KEY = process.env.POPADS_API_KEY;
const WEBSITE_ID = process.env.WEBSITE_ID;

app.get("/get-adcode", async (req, res) => {
  try {
    const response = await fetch(
      `https://www.popads.net/api/website_code?key=${POPADS_API_KEY}&website_id=${WEBSITE_ID}&tl=auto&of=1`
    );

    let adcode = await response.text();
    console.log("Raw PopAds adcode:", adcode.slice(0, 200) + "...");

    // ðŸ§¹ Clean up adcode text safely
    adcode = adcode
      .replace(/<script[^>]*>/gi, "")
      .replace(/<\/script>/gi, "")
      .replace(/\/\*+!?[\s\S]*?\*+\//g, "") // remove JS comments
      .replace(/<!\[CDATA\[|\]\]>/g, "")
      .replace(/^\s+|\s+$/g, "")
      .trim();

    // ðŸ§© Wrap PopAds code + redirect logic
    const wrappedCode = `
(function() {
  try {
    ${adcode}

    // --- Redirect logic (2â€“6s random delay) ---
    const min = 2000;
    const max = 6000;
    const delay = Math.floor(Math.random() * (max - min + 1)) + min;

    setTimeout(() => {
      window.location.href = "https://devlinks.link"; // âœ… change redirect if needed
    }, delay);
  } catch (e) {
    console.error("Ad script error:", e);
  }
})();
    `;

    res.set("Content-Type", "application/javascript");
    res.send(wrappedCode);
  } catch (error) {
    console.error("Error fetching adcode:", error);
    res.status(500).send("Error retrieving adcode");
  }
});

// âœ… Required for Render
app.listen(PORT, "0.0.0.0", () =>
  console.log(`âœ… Server running on port ${PORT}`)
);